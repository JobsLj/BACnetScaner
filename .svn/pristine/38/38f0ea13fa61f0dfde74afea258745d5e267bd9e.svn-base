using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Text;
using System.Threading;
using UDPUtil;
using System.Configuration;
using BACnetCommonLib;
using System.IO;
using NPOI.HSSF.UserModel;
using System.IO.BACnet;
using System.Collections.ObjectModel;

namespace BACnetTranslator
{
    class Program
    {
        static BacnetClient Bacnet_client;
        static AsyncUdpClient Client;
        static ObservableCollection<BacDevice> DevicesList;

        static int invokeId = 0;
        static int GetCurrentInvokeId()
        {
            invokeId++;
            if (invokeId >= 65536) invokeId = 1;
            return invokeId;
        }
        static void Main(string[] args)
        {
            Logger.Log("Begin Translate BACnet Datas");
            Init();
        }
        static void Init()
        {
            Settings.InitSettings();
            BeginScanBac();

            ////本机节点
            //var LocalIP = IPAddress.Parse(ConfigurationManager.AppSettings["LocalIP"]);
            //var LocalPort = int.Parse(ConfigurationManager.AppSettings["LocalPort"]);
            //IPEndPoint localEP = new IPEndPoint(LocalIP, LocalPort);
            //// 远程节点
            //var RemoteIP = IPAddress.Parse(ConfigurationManager.AppSettings["RemoteIP"]);
            //var RemotePort = int.Parse(ConfigurationManager.AppSettings["RemotePort"]);
            //IPEndPoint remoteEP = new IPEndPoint(RemoteIP, RemotePort);
            //Client = new AsyncUdpClient(localEP, remoteEP, false, LoggerImpl.Instance());
            //Client.Start();
        }
        static bool IsDetecteDeviceFinished = false;
        static void BeginScanBac()
        {
            Logger.Log("BeginScanBac");
            Bacnet_client = new BacnetClient(new BacnetIpUdpProtocolTransport(int.Parse(ConfigurationManager.AppSettings["LocalBacPort"]), false));
            Bacnet_client.OnIam -= new BacnetClient.IamHandler(handler_OnIam);
            Bacnet_client.OnIam += new BacnetClient.IamHandler(handler_OnIam);

            Bacnet_client.Start();
            Bacnet_client.WhoIs();
            Thread.Sleep(int.Parse(ConfigurationManager.AppSettings["WaitTime"]));
            IsDetecteDeviceFinished = true;

            ScanBac();
        }
        static void ScanBac()
        {
            if (DevicesList == null) return;
            foreach (var device in DevicesList)
            {
                if (device == null || device.Properties == null) continue;
                try
                {
                    var adr = device.Address;
                    foreach (var pro in device.Properties)
                    {
                        var oid = pro.ObjectId;
                        var invokedId = (byte)(GetCurrentInvokeId() % 256);

                        List<BacnetPropertyReference> rList = new List<BacnetPropertyReference>();
                        rList.Add(new BacnetPropertyReference((uint)BacnetPropertyIds.PROP_PRESENT_VALUE, uint.MaxValue));
                        IList<BacnetReadAccessResult> lstAccessRst;
                        var bRst = Bacnet_client.ReadPropertyMultipleRequest(adr, oid, rList, out lstAccessRst, invokedId);
                        if (bRst)
                        {
                            foreach (var aRst in lstAccessRst)
                            {
                                if (aRst.values == null) continue;
                                foreach (var bPValue in aRst.values)
                                {
                                    if (bPValue.value == null || bPValue.value.Count == 0) continue;
                                    var pid = (BacnetPropertyIds)(bPValue.property.propertyIdentifier);
                                    var bValue = bPValue.value.First();
                                    var strBValue = "" + bValue.Value;
                                    Logger.Log("" + adr + "," + oid.Instance + "," + pro.PROP_OBJECT_NAME + "," + pid + " , " + strBValue + " , " + bValue.Tag);
                                }
                            }
                        }
                    }
                }
                catch (Exception exp)
                {
                    Logger.Error("BeginScanBac: " + exp);
                }
            }
        }
        static void handler_OnIam(BacnetClient sender, BacnetAddress adr, uint deviceId, uint maxAPDU,
                                    BacnetSegmentations segmentation, ushort vendorId)
        {
            if (IsDetecteDeviceFinished) return;
            if (DevicesList == null) DevicesList = new ObservableCollection<BacDevice>();
            lock (DevicesList)
            {
                if (DevicesList.Any(x => x.DeviceId == deviceId)) return;
                var device = new BacDevice(adr, deviceId);
                device.LoadPropertiesFromExcel(Path.Combine(Constants.AimExcelDir, "" + deviceId + ".xls"));
                DevicesList.Add(device);
                Logger.Log(@"Detect Device: " + deviceId);
            }
        }
        static void SendMessage(Bac2UdpNode node, int invokedId = 0)
        {
            if (Client == null || string.IsNullOrEmpty(Settings.BuildingSign) || node == null || node.IsEmpty) return;
            StringBuilder sb = new StringBuilder();
            sb.AppendWithSplit(Settings.BuildingSign);
            sb.AppendWithSplit(Settings.Gateway);
            sb.AppendWithSplit(Settings.SendType);
            sb.AppendWithSplit(DateTime.Now.ToString(@"yyyyMMddHHmmss"));
            sb.AppendWithSplit(invokedId == 0 ? GetCurrentInvokeId() : invokedId);
            sb.Append(node.ToString());
            var str = sb.ToString();
            Client.PushSend(str);
        }
    }
    public class Bac2UdpNode
    {
        public BacProperty BacPro { get; set; }
        public bool IsEmpty
        {
            get
            {
                return string.IsNullOrEmpty(this.MeterSign);
            }
        }
        public string MeterSign { get; set; }
        public string FuncId { get; set; }
        public string FuncValue { get; set; }
        public DateTime LastValueTime { get; set; }
        public override string ToString()
        {
            if (this.IsEmpty) return string.Empty;
            StringBuilder sb = new StringBuilder();
            sb.AppendWithSplit(this.MeterSign);
            sb.AppendWithSplit(1);
            sb.AppendWithSplit(this.FuncId);
            sb.AppendWithSplit(this.FuncValue);
            return sb.Remove(sb.Length - 1, 1).ToString();
        }
        public static List<Bac2UdpNode> LoadBac2UdpNodeFromExcel(string dirPath)
        {
            var lstBac2UdpNode = new List<Bac2UdpNode>();
            if (!Directory.Exists(dirPath)) return lstBac2UdpNode;
            foreach (var file in Directory.GetFiles(dirPath, "*.xls"))
            {
                var fileName = Path.GetFileNameWithoutExtension(file);
                if (fileName.Length < 5) continue;
                var meterSignPre = Settings.MeterSignPre + fileName.Substring(0, fileName.Length - 4) + ".";
                using (FileStream fp = new FileStream(file, FileMode.Open, FileAccess.Read, FileShare.ReadWrite))
                {
                    var book = new HSSFWorkbook(fp);
                    for (int sheetNum = 0; sheetNum < book.NumberOfSheets; sheetNum++)
                    {
                        var sheet = book.GetSheetAt(sheetNum);
                        if (sheet.FirstRowNum < 0 || sheet.FirstRowNum >= sheet.LastRowNum) continue;
                        for (var rowNum = sheet.FirstRowNum + 1; rowNum <= sheet.LastRowNum; rowNum++)
                        {
                            var rowContent = sheet.GetRow(rowNum);
                            if (rowContent == null) continue;
                            Bac2UdpNode node = new Bac2UdpNode();
                            node.BacPro = BacProperty.FromExcelRow(rowContent);
                            if (node.BacPro == null) continue;
                            var meterSignStuff = rowContent.GetCell(1)?.ToString();
                            if (string.IsNullOrEmpty(meterSignStuff)) continue;
                            node.MeterSign = meterSignPre + meterSignStuff;
                            node.FuncId = Settings.FuncId;
                            lstBac2UdpNode.Add(node);
                        }
                    }
                }
            }
            Logger.Log("LoadBac2UdpNodeFromExcel Finished,Count:" + lstBac2UdpNode.Count);
            return lstBac2UdpNode;
        }
    }
}
